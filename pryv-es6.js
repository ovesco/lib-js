var Pryv=function(t){var e={};function s(r){if(e[r])return e[r].exports;var n=e[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=t,s.c=e,s.d=function(t,e,r){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(r,n,function(e){return t[e]}.bind(null,n));return r},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=8)}([function(t,e,s){const r=/(.+):\/\/(.+)@(.+)/gm,n=/(.+):\/\/(.+)/gm,o={superagent:s(11),isBrowser:function(){return"undefined"!=typeof window&&"undefined"!=typeof document},extractTokenAndApiEndpoint:function(t){r.lastIndex=0;const e=r.exec(t);if(null!==e)return e[3].endsWith("/")||(e[3]+="/"),{endpoint:e[1]+"://"+e[3],token:e[2]};n.lastIndex=0;const s=n.exec(t);if(null===s)throw new Error("Cannot find endpoint, invalid URL format");return s[2].endsWith("/")||(s[2]+="/"),{endpoint:s[1]+"://"+s[2],token:null}},buildPryvApiEndpoint:function(t){if(!t.token){let e=t.endpoint+"";return t.endpoint.endsWith("/")||(e+="/"),e}n.lastIndex=0;let e=n.exec(t.endpoint);return e[2].endsWith("/")||(e[2]+="/"),e[1]+"://"+t.token+"@"+e[2]},browserIsMobileOrTablet:function(t){if(null==t)return!1;let e=!1;var s;return s=t.userAgent||t.vendor||t.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(s)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(s.substr(0,4)))&&(e=!0),e},cleanURLFromPrYvParams:function(t){return t.replace(/[?#&]+prYv([^=&]+)=([^&]*)/g,"")},getQueryParamsFromURL:function(t){let e={};return t.replace(/[?#&]+([^=&]+)=([^&]*)/g,(function(t,s,r){e[s]=decodeURIComponent(r)})),e}};t.exports=o},function(t,e){t.exports={ERROR:"error",LOADING:"loading",INITIALIZED:"initialized",AUTHORIZED:"authorized",LOGOUT:"logout"}},function(t,e,s){const r=s(0),n=s(18),o=s(19),i=s(1),a=s(5),{getStore:c}=s(3);class u{constructor(t,e,s){if(this._pryvServiceInfo=null,this._assets=null,this._polling=!1,this._pryvServiceInfoUrl=t,this._pryvServiceCustomizations=e,this.store=c(),null!=s){const t="pryv-libjs-";this._cookieKey=t+s}this.store.messages=a(this.store.languageCode)}async info(t){if(t||!this._pryvServiceInfo){let t={};if(this._pryvServiceInfoUrl){t=(await r.superagent.get(this._pryvServiceInfoUrl).set("Access-Control-Allow-Origin","*").set("accept","json")).body}Object.assign(t,this._pryvServiceCustomizations),this.setServiceInfo(t)}return this._pryvServiceInfo}setServiceInfo(t){if(!t.name)throw new Error("Invalid data from service/info");["access","api","register"].forEach(e=>{"/"!==t[e].slice(-1)&&(t[e]+="/")}),this._pryvServiceInfo=t}async assets(t){if(!t&&this._assets)return this._assets;{const t=await this.info();return t.assets&&t.assets.definitions?(this._assets=await n.setup(t.assets.definitions),this._assets):(console.log("Warning: no assets for this service"),null)}}infoSync(){return this._pryvServiceInfo}async apiEndpointFor(t,e){const s=await this.info();return u.buildAPIEndpoint(s,t,e)}static buildAPIEndpoint(t,e,s){const n=t.api.replace("{username}",e);return r.buildPryvApiEndpoint({endpoint:n,token:s})}async login(t,e,s,n){const o=await this.apiEndpointFor(t);try{const i={accept:"json"};n=n||(await this.info()).register,r.isBrowser()||(i.Origin=n);const a=await r.superagent.post(o+"auth/login").set(i).send({username:t,password:e,appId:s});if(!a.body.token)throw new Error("Invalid login response: "+a.body);return new h(u.buildAPIEndpoint(await this.info(),t,a.body.token),this)}catch(t){if(t.response&&t.response.body&&t.response.body.error&&t.response.body.error.message)throw new Error(t.response.body.error.message)}}async startAuthRequest(){this._polling||await this._poll()}async _poll(){this.store.accessData&&"NEED_SIGNIN"!=this.store.accessData.status?this._polling=!1:(this._polling=!0,this.changeAuthStateDependingOnAccess(await this._pollAccess()),setTimeout(await this._poll.bind(this),this.store.accessData.poll_rate_ms))}stopAuthRequest(){this.store.accessData={status:"ERROR"}}async _pollAccess(){let t;try{t=await r.superagent.get(this.store.accessData.poll).set("accept","json")}catch(t){return{status:"ERROR"}}return t.body}changeAuthStateDependingOnAccess(t){if(!t||!t.status)throw this.store.setState({id:i.ERROR,message:"Invalid Access data response",error:new Error("Invalid Access data response")}),this.store.state.error;switch(this.store.accessData=t,this.store.accessData.status){case"ERROR":this.store.setState({id:i.ERROR,message:"Error on the backend, please refresh"});break;case"ACCEPTED":const t=u.buildAPIEndpoint(this._pryvServiceInfo,this.store.accessData.username,this.store.accessData.token);o.set(this._cookieKey,{apiEndpoint:t,displayName:this.store.accessData.username}),this.store.setState({id:i.AUTHORIZED,apiEndpoint:t,displayName:this.store.accessData.username})}}getAccessData(){return this.store.accessData}setAccessData(t){this.store.accessData=t}getCurrentCookieInfo(){return o.get(this._cookieKey)}async deleteCurrentAuthInfo(){o.del(this._cookieKey),this.store.accessData=null}getErrorMessage(){return this.store.messages.ERROR+": "+this.store.state.message}getLoadingMessage(){return this.store.messages.LOADING}getInitializedMessage(){return this.store.messages.LOGIN+": "+this._pryvServiceInfo.name}getAuthorizedMessage(){return this.store.state.displayName}defaultOnStateChange(){let t="";switch(this.store.state.id){case i.ERROR:t=this.getErrorMessage();break;case i.LOADING:t=this.getLoadingMessage();break;case i.INITIALIZED:t=this.getInitializedMessage();break;case i.AUTHORIZED:t=this.getAuthorizedMessage();break;default:console.log("WARNING Unhandled state for Login: "+this.store.state.id)}return t}getAssets(){return this.store.assets}extractTokenAndApiEndpoint(t){return r.extractTokenAndApiEndpoint(t)}}t.exports=u;const h=s(6)},function(t,e,s){s(1);let r=null;t.exports={getStore:function(){return null==r&&(r=new n),r}};class n{constructor(){this.setInitialValues()}setState(t){this.state=t,this.stateChangeListners.map(e=>{try{e(t)}catch(t){console.log(t)}})}resetValues(){this.setInitialValues()}setInitialValues(){this.state={id:""},this.accessData={poll:"",authUrl:"",status:""},this.stateChangeListners=[],this.messages={},this.languageCode="en"}}},function(t,e,s){"use strict";function r(t){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}t.exports=function(t){return null!==t&&"object"===r(t)}},function(t,e){const s={LOADING:{en:"..."},ERROR:{en:"Error",fr:"Erreur"},LOGIN:{en:"Signin",fr:"Login"},LOGOUT_CONFIRM:{en:"Logout ?",fr:"Se deconnecter ?"}};t.exports=function(t,e){const r=e||s,n={};return Object.keys(r).map(e=>{n[e]=r[e][t]||r[e].en}),n}},function(t,e,s){const r=s(0),n=s(20),o=s(21);t.exports=class{constructor(t,e){const{token:s,endpoint:n}=r.extractTokenAndApiEndpoint(t);if(this.token=s,this.endpoint=n,this.options={},this.options.chunkSize=1e3,this._deltaTime={value:0,weight:0},!e instanceof i)throw new Error("Invalid service param");this._service=e}get service(){return this._service||(this._service=new i(this.endpoint+"service/info")),this._service}async username(){return(await this.accessInfo()).user.username}async accessInfo(){return this.get("access-info",null)}async api(t,e){return await this._chunkedBatchCall(t,e,function(t){return this.post("",t)}.bind(this))}async _chunkedBatchCall(t,e,s){if(!Array.isArray(t))throw new Error("Pryv.api() takes an array as input");const r=[];let n=0;for(let o=0;t.length>=o;o+=this.options.chunkSize){const i=[],a=Math.min(o+this.options.chunkSize,t.length);for(let e=o;e<a;e++)i.push({method:t[e].method,params:t[e].params});const c=await s(i);if(!c||!Array.isArray(c.results))throw new Error("API call result is not an Array: "+JSON.stringify(c));if(c.results.length!=i.length)throw new Error("API call result Array does not match request: "+JSON.stringify(c));for(let e=0;e<c.results.length;e++)t[e+o].handleResult&&await t[e+o].handleResult.call(null,c.results[e]);Array.prototype.push.apply(r,c.results),n=Math.round(100*r.length/t.length),e&&e(n,r)}return r}async post(t,e,s){const r=Date.now()/1e3,n=await this.postRaw(t,e,s);return this._handleMeta(n.body,r),n.body}async postRaw(t,e,s){return this._post(t).query(s).send(e)}_post(t){return r.superagent.post(this.endpoint+t).set("Authorization",this.token).set("accept","json")}async get(t,e){const s=Date.now()/1e3,r=await this.getRaw(t,e);return this._handleMeta(r.body,s),r.body}getRaw(t,e){return t=t||"",r.superagent.get(this.endpoint+t).set("Authorization",this.token).set("accept","json").query(e)}async addPointsToHFEvent(t,e,s){const r=await this.post("events/"+t+"/series",{format:"flatJSON",fields:e,points:s});if("ok"===!r.status)throw new Error("Failed loading serie: "+JSON.stringify(r.status));return r}async getEventsStreamed(t,e){const s=n(e,t.includeDeletions);let r=null;"undefined"==typeof window?r=await this.getRaw("events",t).buffer(!1).parse(s):"undefined"!=typeof fetch?r=await o(this,t,s):(console.log("WARNING: Browser does not support fetch() required by Pryv.Connection.getEventsStreamed()"),r=await this.getRaw("events",t),r.body.eventsCount=0,r.body.events&&(r.body.events.forEach(e),r.body.eventsCount+=r.body.events.length,delete r.body.events),r.body.eventDeletions&&(r.body.eventDeletions.forEach(e),r.body.eventsCount+=r.body.eventDeletions.length,delete r.body.eventDeletions));const i=Date.now()/1e3;return this._handleMeta(r.body,i),r.body}async createEventWithFile(t,e){const s=await this._post("events").field("event",JSON.stringify(t)).attach("file",e),r=Date.now()/1e3;return this._handleMeta(s.body,r),s.body}async createEventWithFormData(t,e){e.append("event",JSON.stringify(t));return(await this._post("events").send(e)).body}get deltaTime(){return this._deltaTime.value}get apiEndpoint(){return r.buildPryvApiEndpoint(this)}_handleMeta(t,e){if(!t.meta)throw new Error("Cannot find .meta in response.");if(!t.meta.serverTime)throw new Error("Cannot find .meta.serverTime in response.");this._deltaTime.value=(this._deltaTime.value*this._deltaTime.weight+t.meta.serverTime-e)/++this._deltaTime.weight}};const i=s(2)},function(t,e){t.exports=class{constructor(t){this.auth=t}async init(){}onStateChange(){throw new Error("onStateChange() must be implemented")}onClick(){}}},function(t,e,s){t.exports=s(9)},function(t,e,s){const r=s(10);t.exports=r},function(t,e,s){t.exports={Service:s(2),Connection:s(6),Browser:s(22),utils:s(0),version:s(25).version}},function(t,e,s){"use strict";function r(t){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var n;"undefined"!=typeof window?n=window:"undefined"==typeof self?(console.warn("Using browser-only version of superagent in non-browser environment"),n=void 0):n=self;var o=s(12),i=s(13),a=s(14),c=s(4),u=s(15),h=s(17);function l(){}t.exports=function(t,s){return"function"==typeof s?new e.Request("GET",t).end(s):1===arguments.length?new e.Request("GET",t):new e.Request(t,s)};var p=e=t.exports;e.Request=w,p.getXHR=function(){if(n.XMLHttpRequest&&(!n.location||"file:"!==n.location.protocol||!n.ActiveXObject))return new XMLHttpRequest;try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(t){}throw new Error("Browser-only version of superagent could not find XHR")};var d="".trim?function(t){return t.trim()}:function(t){return t.replace(/(^\s*|\s*$)/g,"")};function f(t){if(!c(t))return t;var e=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&y(e,s,t[s]);return e.join("&")}function y(t,e,s){if(void 0!==s)if(null!==s)if(Array.isArray(s))s.forEach((function(s){y(t,e,s)}));else if(c(s))for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&y(t,"".concat(e,"[").concat(r,"]"),s[r]);else t.push(encodeURI(e)+"="+encodeURIComponent(s));else t.push(encodeURI(e))}function m(t){for(var e,s,r={},n=t.split("&"),o=0,i=n.length;o<i;++o)-1===(s=(e=n[o]).indexOf("="))?r[decodeURIComponent(e)]="":r[decodeURIComponent(e.slice(0,s))]=decodeURIComponent(e.slice(s+1));return r}function g(t){return/[/+]json($|[^-\w])/.test(t)}function v(t){this.req=t,this.xhr=this.req.xhr,this.text="HEAD"!==this.req.method&&(""===this.xhr.responseType||"text"===this.xhr.responseType)||void 0===this.xhr.responseType?this.xhr.responseText:null,this.statusText=this.req.xhr.statusText;var e=this.xhr.status;1223===e&&(e=204),this._setStatusProperties(e),this.headers=function(t){for(var e,s,r,n,o=t.split(/\r?\n/),i={},a=0,c=o.length;a<c;++a)-1!==(e=(s=o[a]).indexOf(":"))&&(r=s.slice(0,e).toLowerCase(),n=d(s.slice(e+1)),i[r]=n);return i}(this.xhr.getAllResponseHeaders()),this.header=this.headers,this.header["content-type"]=this.xhr.getResponseHeader("content-type"),this._setHeaderProperties(this.header),null===this.text&&t._responseType?this.body=this.xhr.response:this.body="HEAD"===this.req.method?null:this._parseBody(this.text?this.text:this.xhr.response)}function w(t,e){var s=this;this._query=this._query||[],this.method=t,this.url=e,this.header={},this._header={},this.on("end",(function(){var t,e=null,r=null;try{r=new v(s)}catch(t){return(e=new Error("Parser is unable to parse the response")).parse=!0,e.original=t,s.xhr?(e.rawResponse=void 0===s.xhr.responseType?s.xhr.responseText:s.xhr.response,e.status=s.xhr.status?s.xhr.status:null,e.statusCode=e.status):(e.rawResponse=null,e.status=null),s.callback(e)}s.emit("response",r);try{s._isResponseOK(r)||(t=new Error(r.statusText||r.text||"Unsuccessful HTTP response"))}catch(e){t=e}t?(t.original=e,t.response=r,t.status=r.status,s.callback(t,r)):s.callback(null,r)}))}function b(t,e,s){var r=p("DELETE",t);return"function"==typeof e&&(s=e,e=null),e&&r.send(e),s&&r.end(s),r}p.serializeObject=f,p.parseString=m,p.types={html:"text/html",json:"application/json",xml:"text/xml",urlencoded:"application/x-www-form-urlencoded",form:"application/x-www-form-urlencoded","form-data":"application/x-www-form-urlencoded"},p.serialize={"application/x-www-form-urlencoded":f,"application/json":i},p.parse={"application/x-www-form-urlencoded":m,"application/json":JSON.parse},u(v.prototype),v.prototype._parseBody=function(t){var e=p.parse[this.type];return this.req._parser?this.req._parser(this,t):(!e&&g(this.type)&&(e=p.parse["application/json"]),e&&t&&(t.length>0||t instanceof Object)?e(t):null)},v.prototype.toError=function(){var t=this.req,e=t.method,s=t.url,r="cannot ".concat(e," ").concat(s," (").concat(this.status,")"),n=new Error(r);return n.status=this.status,n.method=e,n.url=s,n},p.Response=v,o(w.prototype),a(w.prototype),w.prototype.type=function(t){return this.set("Content-Type",p.types[t]||t),this},w.prototype.accept=function(t){return this.set("Accept",p.types[t]||t),this},w.prototype.auth=function(t,e,s){1===arguments.length&&(e=""),"object"===r(e)&&null!==e&&(s=e,e=""),s||(s={type:"function"==typeof btoa?"basic":"auto"});var n=function(t){if("function"==typeof btoa)return btoa(t);throw new Error("Cannot use basic auth, btoa is not a function")};return this._auth(t,e,s,n)},w.prototype.query=function(t){return"string"!=typeof t&&(t=f(t)),t&&this._query.push(t),this},w.prototype.attach=function(t,e,s){if(e){if(this._data)throw new Error("superagent can't mix .send() and .attach()");this._getFormData().append(t,e,s||e.name)}return this},w.prototype._getFormData=function(){return this._formData||(this._formData=new n.FormData),this._formData},w.prototype.callback=function(t,e){if(this._shouldRetry(t,e))return this._retry();var s=this._callback;this.clearTimeout(),t&&(this._maxRetries&&(t.retries=this._retries-1),this.emit("error",t)),s(t,e)},w.prototype.crossDomainError=function(){var t=new Error("Request has been terminated\nPossible causes: the network is offline, Origin is not allowed by Access-Control-Allow-Origin, the page is being unloaded, etc.");t.crossDomain=!0,t.status=this.status,t.method=this.method,t.url=this.url,this.callback(t)},w.prototype.agent=function(){return console.warn("This is not supported in browser version of superagent"),this},w.prototype.ca=w.prototype.agent,w.prototype.buffer=w.prototype.ca,w.prototype.write=function(){throw new Error("Streaming is not supported in browser version of superagent")},w.prototype.pipe=w.prototype.write,w.prototype._isHost=function(t){return t&&"object"===r(t)&&!Array.isArray(t)&&"[object Object]"!==Object.prototype.toString.call(t)},w.prototype.end=function(t){this._endCalled&&console.warn("Warning: .end() was called twice. This is not supported in superagent"),this._endCalled=!0,this._callback=t||l,this._finalizeQueryString(),this._end()},w.prototype._setUploadTimeout=function(){var t=this;this._uploadTimeout&&!this._uploadTimeoutTimer&&(this._uploadTimeoutTimer=setTimeout((function(){t._timeoutError("Upload timeout of ",t._uploadTimeout,"ETIMEDOUT")}),this._uploadTimeout))},w.prototype._end=function(){if(this._aborted)return this.callback(new Error("The request has been aborted even before .end() was called"));var t=this;this.xhr=p.getXHR();var e=this.xhr,s=this._formData||this._data;this._setTimeouts(),e.onreadystatechange=function(){var s=e.readyState;if(s>=2&&t._responseTimeoutTimer&&clearTimeout(t._responseTimeoutTimer),4===s){var r;try{r=e.status}catch(t){r=0}if(!r){if(t.timedout||t._aborted)return;return t.crossDomainError()}t.emit("end")}};var r=function(e,s){s.total>0&&(s.percent=s.loaded/s.total*100,100===s.percent&&clearTimeout(t._uploadTimeoutTimer)),s.direction=e,t.emit("progress",s)};if(this.hasListeners("progress"))try{e.addEventListener("progress",r.bind(null,"download")),e.upload&&e.upload.addEventListener("progress",r.bind(null,"upload"))}catch(t){}e.upload&&this._setUploadTimeout();try{this.username&&this.password?e.open(this.method,this.url,!0,this.username,this.password):e.open(this.method,this.url,!0)}catch(t){return this.callback(t)}if(this._withCredentials&&(e.withCredentials=!0),!this._formData&&"GET"!==this.method&&"HEAD"!==this.method&&"string"!=typeof s&&!this._isHost(s)){var n=this._header["content-type"],o=this._serializer||p.serialize[n?n.split(";")[0]:""];!o&&g(n)&&(o=p.serialize["application/json"]),o&&(s=o(s))}for(var i in this.header)null!==this.header[i]&&Object.prototype.hasOwnProperty.call(this.header,i)&&e.setRequestHeader(i,this.header[i]);this._responseType&&(e.responseType=this._responseType),this.emit("request",this),e.send(void 0===s?null:s)},p.agent=function(){return new h},["GET","POST","OPTIONS","PATCH","PUT","DELETE"].forEach((function(t){h.prototype[t.toLowerCase()]=function(e,s){var r=new p.Request(t,e);return this._setDefaults(r),s&&r.end(s),r}})),h.prototype.del=h.prototype.delete,p.get=function(t,e,s){var r=p("GET",t);return"function"==typeof e&&(s=e,e=null),e&&r.query(e),s&&r.end(s),r},p.head=function(t,e,s){var r=p("HEAD",t);return"function"==typeof e&&(s=e,e=null),e&&r.query(e),s&&r.end(s),r},p.options=function(t,e,s){var r=p("OPTIONS",t);return"function"==typeof e&&(s=e,e=null),e&&r.send(e),s&&r.end(s),r},p.del=b,p.delete=b,p.patch=function(t,e,s){var r=p("PATCH",t);return"function"==typeof e&&(s=e,e=null),e&&r.send(e),s&&r.end(s),r},p.post=function(t,e,s){var r=p("POST",t);return"function"==typeof e&&(s=e,e=null),e&&r.send(e),s&&r.end(s),r},p.put=function(t,e,s){var r=p("PUT",t);return"function"==typeof e&&(s=e,e=null),e&&r.send(e),s&&r.end(s),r}},function(t,e,s){function r(t){if(t)return function(t){for(var e in r.prototype)t[e]=r.prototype[e];return t}(t)}t.exports=r,r.prototype.on=r.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this},r.prototype.once=function(t,e){function s(){this.off(t,s),e.apply(this,arguments)}return s.fn=e,this.on(t,s),this},r.prototype.off=r.prototype.removeListener=r.prototype.removeAllListeners=r.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var s,r=this._callbacks["$"+t];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(var n=0;n<r.length;n++)if((s=r[n])===e||s.fn===e){r.splice(n,1);break}return 0===r.length&&delete this._callbacks["$"+t],this},r.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),s=this._callbacks["$"+t],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(s){r=0;for(var n=(s=s.slice(0)).length;r<n;++r)s[r].apply(this,e)}return this},r.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},r.prototype.hasListeners=function(t){return!!this.listeners(t).length}},function(t,e){t.exports=n,n.default=n,n.stable=i,n.stableStringify=i;var s=[],r=[];function n(t,e,n){var o;for(!function t(e,n,o,i){var a;if("object"==typeof e&&null!==e){for(a=0;a<o.length;a++)if(o[a]===e){var c=Object.getOwnPropertyDescriptor(i,n);return void(void 0!==c.get?c.configurable?(Object.defineProperty(i,n,{value:"[Circular]"}),s.push([i,n,e,c])):r.push([e,n]):(i[n]="[Circular]",s.push([i,n,e])))}if(o.push(e),Array.isArray(e))for(a=0;a<e.length;a++)t(e[a],a,o,e);else{var u=Object.keys(e);for(a=0;a<u.length;a++){var h=u[a];t(e[h],h,o,e)}}o.pop()}}(t,"",[],void 0),o=0===r.length?JSON.stringify(t,e,n):JSON.stringify(t,a(e),n);0!==s.length;){var i=s.pop();4===i.length?Object.defineProperty(i[0],i[1],i[3]):i[0][i[1]]=i[2]}return o}function o(t,e){return t<e?-1:t>e?1:0}function i(t,e,n){var i,c=function t(e,n,i,a){var c;if("object"==typeof e&&null!==e){for(c=0;c<i.length;c++)if(i[c]===e){var u=Object.getOwnPropertyDescriptor(a,n);return void(void 0!==u.get?u.configurable?(Object.defineProperty(a,n,{value:"[Circular]"}),s.push([a,n,e,u])):r.push([e,n]):(a[n]="[Circular]",s.push([a,n,e])))}if("function"==typeof e.toJSON)return;if(i.push(e),Array.isArray(e))for(c=0;c<e.length;c++)t(e[c],c,i,e);else{var h={},l=Object.keys(e).sort(o);for(c=0;c<l.length;c++){var p=l[c];t(e[p],p,i,e),h[p]=e[p]}if(void 0===a)return h;s.push([a,n,e]),a[n]=h}i.pop()}}(t,"",[],void 0)||t;for(i=0===r.length?JSON.stringify(c,e,n):JSON.stringify(c,a(e),n);0!==s.length;){var u=s.pop();4===u.length?Object.defineProperty(u[0],u[1],u[3]):u[0][u[1]]=u[2]}return i}function a(t){return t=void 0!==t?t:function(t,e){return e},function(e,s){if(r.length>0)for(var n=0;n<r.length;n++){var o=r[n];if(o[1]===e&&o[0]===s){s="[Circular]",r.splice(n,1);break}}return t.call(this,e,s)}}},function(t,e,s){"use strict";function r(t){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var n=s(4);function o(t){if(t)return function(t){for(var e in o.prototype)Object.prototype.hasOwnProperty.call(o.prototype,e)&&(t[e]=o.prototype[e]);return t}(t)}t.exports=o,o.prototype.clearTimeout=function(){return clearTimeout(this._timer),clearTimeout(this._responseTimeoutTimer),clearTimeout(this._uploadTimeoutTimer),delete this._timer,delete this._responseTimeoutTimer,delete this._uploadTimeoutTimer,this},o.prototype.parse=function(t){return this._parser=t,this},o.prototype.responseType=function(t){return this._responseType=t,this},o.prototype.serialize=function(t){return this._serializer=t,this},o.prototype.timeout=function(t){if(!t||"object"!==r(t))return this._timeout=t,this._responseTimeout=0,this._uploadTimeout=0,this;for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e))switch(e){case"deadline":this._timeout=t.deadline;break;case"response":this._responseTimeout=t.response;break;case"upload":this._uploadTimeout=t.upload;break;default:console.warn("Unknown timeout option",e)}return this},o.prototype.retry=function(t,e){return 0!==arguments.length&&!0!==t||(t=1),t<=0&&(t=0),this._maxRetries=t,this._retries=0,this._retryCallback=e,this};var i=["ECONNRESET","ETIMEDOUT","EADDRINFO","ESOCKETTIMEDOUT"];o.prototype._shouldRetry=function(t,e){if(!this._maxRetries||this._retries++>=this._maxRetries)return!1;if(this._retryCallback)try{var s=this._retryCallback(t,e);if(!0===s)return!0;if(!1===s)return!1}catch(t){console.error(t)}if(e&&e.status&&e.status>=500&&501!==e.status)return!0;if(t){if(t.code&&i.includes(t.code))return!0;if(t.timeout&&"ECONNABORTED"===t.code)return!0;if(t.crossDomain)return!0}return!1},o.prototype._retry=function(){return this.clearTimeout(),this.req&&(this.req=null,this.req=this.request()),this._aborted=!1,this.timedout=!1,this.timedoutError=null,this._end()},o.prototype.then=function(t,e){var s=this;if(!this._fullfilledPromise){var r=this;this._endCalled&&console.warn("Warning: superagent request was sent twice, because both .end() and .then() were called. Never call .end() if you use promises"),this._fullfilledPromise=new Promise((function(t,e){r.on("abort",(function(){if(!(s._maxRetries&&s._maxRetries>s._retries))if(s.timedout&&s.timedoutError)e(s.timedoutError);else{var t=new Error("Aborted");t.code="ABORTED",t.status=s.status,t.method=s.method,t.url=s.url,e(t)}})),r.end((function(s,r){s?e(s):t(r)}))}))}return this._fullfilledPromise.then(t,e)},o.prototype.catch=function(t){return this.then(void 0,t)},o.prototype.use=function(t){return t(this),this},o.prototype.ok=function(t){if("function"!=typeof t)throw new Error("Callback required");return this._okCallback=t,this},o.prototype._isResponseOK=function(t){return!!t&&(this._okCallback?this._okCallback(t):t.status>=200&&t.status<300)},o.prototype.get=function(t){return this._header[t.toLowerCase()]},o.prototype.getHeader=o.prototype.get,o.prototype.set=function(t,e){if(n(t)){for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&this.set(s,t[s]);return this}return this._header[t.toLowerCase()]=e,this.header[t]=e,this},o.prototype.unset=function(t){return delete this._header[t.toLowerCase()],delete this.header[t],this},o.prototype.field=function(t,e){if(null==t)throw new Error(".field(name, val) name can not be empty");if(this._data)throw new Error(".field() can't be used if .send() is used. Please use only .send() or only .field() & .attach()");if(n(t)){for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&this.field(s,t[s]);return this}if(Array.isArray(e)){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&this.field(t,e[r]);return this}if(null==e)throw new Error(".field(name, val) val can not be empty");return"boolean"==typeof e&&(e=String(e)),this._getFormData().append(t,e),this},o.prototype.abort=function(){return this._aborted||(this._aborted=!0,this.xhr&&this.xhr.abort(),this.req&&this.req.abort(),this.clearTimeout(),this.emit("abort")),this},o.prototype._auth=function(t,e,s,r){switch(s.type){case"basic":this.set("Authorization","Basic ".concat(r("".concat(t,":").concat(e))));break;case"auto":this.username=t,this.password=e;break;case"bearer":this.set("Authorization","Bearer ".concat(t))}return this},o.prototype.withCredentials=function(t){return void 0===t&&(t=!0),this._withCredentials=t,this},o.prototype.redirects=function(t){return this._maxRedirects=t,this},o.prototype.maxResponseSize=function(t){if("number"!=typeof t)throw new TypeError("Invalid argument");return this._maxResponseSize=t,this},o.prototype.toJSON=function(){return{method:this.method,url:this.url,data:this._data,headers:this._header}},o.prototype.send=function(t){var e=n(t),s=this._header["content-type"];if(this._formData)throw new Error(".send() can't be used if .attach() or .field() is used. Please use only .send() or only .field() & .attach()");if(e&&!this._data)Array.isArray(t)?this._data=[]:this._isHost(t)||(this._data={});else if(t&&this._data&&this._isHost(this._data))throw new Error("Can't merge these send calls");if(e&&n(this._data))for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(this._data[r]=t[r]);else"string"==typeof t?(s||this.type("form"),s=this._header["content-type"],this._data="application/x-www-form-urlencoded"===s?this._data?"".concat(this._data,"&").concat(t):t:(this._data||"")+t):this._data=t;return!e||this._isHost(t)||s||this.type("json"),this},o.prototype.sortQuery=function(t){return this._sort=void 0===t||t,this},o.prototype._finalizeQueryString=function(){var t=this._query.join("&");if(t&&(this.url+=(this.url.includes("?")?"&":"?")+t),this._query.length=0,this._sort){var e=this.url.indexOf("?");if(e>=0){var s=this.url.slice(e+1).split("&");"function"==typeof this._sort?s.sort(this._sort):s.sort(),this.url=this.url.slice(0,e)+"?"+s.join("&")}}},o.prototype._appendQueryString=function(){console.warn("Unsupported")},o.prototype._timeoutError=function(t,e,s){if(!this._aborted){var r=new Error("".concat(t+e,"ms exceeded"));r.timeout=e,r.code="ECONNABORTED",r.errno=s,this.timedout=!0,this.timedoutError=r,this.abort(),this.callback(r)}},o.prototype._setTimeouts=function(){var t=this;this._timeout&&!this._timer&&(this._timer=setTimeout((function(){t._timeoutError("Timeout of ",t._timeout,"ETIME")}),this._timeout)),this._responseTimeout&&!this._responseTimeoutTimer&&(this._responseTimeoutTimer=setTimeout((function(){t._timeoutError("Response timeout of ",t._responseTimeout,"ETIMEDOUT")}),this._responseTimeout))}},function(t,e,s){"use strict";var r=s(16);function n(t){if(t)return function(t){for(var e in n.prototype)Object.prototype.hasOwnProperty.call(n.prototype,e)&&(t[e]=n.prototype[e]);return t}(t)}t.exports=n,n.prototype.get=function(t){return this.header[t.toLowerCase()]},n.prototype._setHeaderProperties=function(t){var e=t["content-type"]||"";this.type=r.type(e);var s=r.params(e);for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(this[n]=s[n]);this.links={};try{t.link&&(this.links=r.parseLinks(t.link))}catch(t){}},n.prototype._setStatusProperties=function(t){var e=t/100|0;this.statusCode=t,this.status=this.statusCode,this.statusType=e,this.info=1===e,this.ok=2===e,this.redirect=3===e,this.clientError=4===e,this.serverError=5===e,this.error=(4===e||5===e)&&this.toError(),this.created=201===t,this.accepted=202===t,this.noContent=204===t,this.badRequest=400===t,this.unauthorized=401===t,this.notAcceptable=406===t,this.forbidden=403===t,this.notFound=404===t,this.unprocessableEntity=422===t}},function(t,e,s){"use strict";e.type=function(t){return t.split(/ *; */).shift()},e.params=function(t){return t.split(/ *; */).reduce((function(t,e){var s=e.split(/ *= */),r=s.shift(),n=s.shift();return r&&n&&(t[r]=n),t}),{})},e.parseLinks=function(t){return t.split(/ *, */).reduce((function(t,e){var s=e.split(/ *; */),r=s[0].slice(1,-1);return t[s[1].split(/ *= */)[1].slice(1,-1)]=r,t}),{})},e.cleanHeader=function(t,e){return delete t["content-type"],delete t["content-length"],delete t["transfer-encoding"],delete t.host,e&&(delete t.authorization,delete t.cookie),t}},function(t,e,s){"use strict";function r(t){return function(t){if(Array.isArray(t))return n(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return n(t,e);var s=Object.prototype.toString.call(t).slice(8,-1);"Object"===s&&t.constructor&&(s=t.constructor.name);if("Map"===s||"Set"===s)return Array.from(t);if("Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return n(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var s=0,r=new Array(e);s<e;s++)r[s]=t[s];return r}function o(){this._defaults=[]}["use","on","once","set","query","type","accept","auth","withCredentials","sortQuery","retry","ok","redirects","timeout","buffer","serialize","parse","ca","key","pfx","cert","disableTLSCerts"].forEach((function(t){o.prototype[t]=function(){for(var e=arguments.length,s=new Array(e),r=0;r<e;r++)s[r]=arguments[r];return this._defaults.push({fn:t,args:s}),this}})),o.prototype._setDefaults=function(t){this._defaults.forEach((function(e){t[e.fn].apply(t,r(e.args))}))},t.exports=o},function(t,e,s){const r=s(0);class n{constructor(t,e){this._assets=t,this._assetsURL=e}static async setup(t){const e=await r.superagent.get(t).set("accept","json");return new n(e.body,t)}get(t){let e=Object.assign({},this._assets);return t&&t.split(":").forEach(t=>{if(e=e[t],void 0===e)return e}),e}getUrl(t){const e=this.get(t);if("string"!=typeof e)throw new Error(e+" returned "+value);return this.relativeURL(e)}relativeURL(t){return function(t,e){var s=location;t&&((s=document.createElement("a")).href=t);for(var r,n,o="",i=s.pathname.replace(/[^\/]*$/,e.replace(/(\/|^)(?:\.?\/+)+/g,"$1")),a=0;(n=i.indexOf("/../",a))>-1;a=n+r)r=/^\/(?:\.\.\/)*/.exec(i.slice(n))[0].length,o=(o+i.substring(a,n)).replace(new RegExp("(?:\\/+[^\\/]*){0,"+(r-1)/3+"}$"),"/");let c=s.port?":"+s.port:"";return s.protocol+"//"+s.hostname+c+o+i.substr(a)}(this._assets.baseUrl||this._assetsURL,t)}async setAllDefaults(){this.setFavicon(),await this.loadCSS()}setFavicon(){var t=document.querySelector("link[rel*='icon']")||document.createElement("link");t.type="image/x-icon",t.rel="shortcut icon",t.href=this.relativeURL(this._assets.favicon.default.url),document.getElementsByTagName("head")[0].appendChild(t)}async loadCSS(){o(this.relativeURL(this._assets.css.default.url))}async loginButtonLoadCSS(){o(this.relativeURL(this._assets["lib-js"].buttonSignIn.css))}async loginButtonGetHTML(){return(await r.superagent.get(this.relativeURL(this._assets["lib-js"].buttonSignIn.html)).set("accept","html")).text}async loginButtonGetMessages(){return(await r.superagent.get(this.relativeURL(this._assets["lib-js"].buttonSignIn.messages)).set("accept","json")).body}}function o(t){var e=document.getElementsByTagName("head")[0],s=document.createElement("link");s.id=t,s.rel="stylesheet",s.type="text/css",s.href=t,s.media="all",e.appendChild(s)}t.exports=n},function(t,e,s){const r=s(0);function n(t,e,s){if(r.isBrowser()){s=s||365;var n=new Date,o=window.location.hostname,i=window.location.pathname;n.setDate(n.getDate()+s);var a=encodeURIComponent(t)+"="+encodeURIComponent(JSON.stringify(e))+";expires="+n.toGMTString()+";domain=."+o+";path="+i;s>=0&&(a+=";SameSite=Strict"),document.cookie=a}}e.set=n,e.get=function(t){const e=encodeURIComponent(t);if(r.isBrowser()){var s=("; "+document.cookie).split("; "+e+"=");return 2==s.length?JSON.parse(decodeURIComponent(s.pop().split(";").shift())):void 0}},e.del=function(t){n(t,{deleted:!0},-1)}},function(t,e){const s=['"events":[','"eventDeletions":['];t.exports=function(t,e){let r=0,n="",o=null,i=0,a=!1,c=!1,u=0,h=0,l=0;const p=0,d=1,f=2;let y=p;function m(){switch(y){case p:(t=n.indexOf(s[r]))>0&&(0===r&&(o=n.substring(0,t)),n=n.substr(t+s[r].length),y=d,g());break;case d:g();break;default:o+=n,n=""}var t}function g(){for(;u<n.length&&y===d;)if(c)c=!1,u++;else{switch(n.charCodeAt(u)){case 93:if(0===i){if(0!==u)throw new Error("Found trailling ] in mid-course");if(0===r&&e)return y=p,void(r=1);{y=f;let t="";1===r&&(t='"eventDeletionsCount":'+l+","),n=t+'"eventsCount":'+h+n.substr(1)}}break;case 92:c=!0;break;case 123:a||i++;break;case 34:a=!a;break;case 125:if(a||i--,0===i){const e=44===n.charCodeAt(0)?1:0,o=n.substring(e,u+1);0===r?h++:l++,n=n.substr(u+1),s=o,t(JSON.parse(s)),u=-1}}u++}var s}return function(t,e){t.setEncoding("utf8"),t.on("data",t=>{n+=t,m()}),t.on("end",()=>{let s,r;try{t.text=o+n,r=t.text&&JSON.parse(t.text)}catch(e){s=e,s.rawResponse=t.text||null,s.statusCode=t.statusCode}finally{e(s,r)}})}}},function(t,e){t.exports=async function(t,e,s){const r={ondata:null,onend:null,encoding:"utf8"},n={setEncoding:function(t){r.encoding=t},on:function(t,e){r["on"+t]=e}};let o,i;s(n,(function(t,e){o=t,i=e}));let a=new URL(t.endpoint+"events");a.search=new URLSearchParams(e);let c={method:"GET",headers:{Accept:"application/jon"}};t.token&&(c.headers.Authorization=t.token);let u=await fetch(a,c);const h=u.body.getReader();for(;;){const{done:t,value:e}=await h.read();if(r.ondata(new TextDecoder(r.encoding).decode(e)),t){r.onend();break}}if(o)throw new Error(o);const l={text:n.text,body:i,statusCode:u.status,headers:{}};for(var p of u.headers.entries())l.headers[p[0]]=p[1];return l}},function(t,e,s){const r=s(23),n=s(1),o=s(7),i=s(24),{getStore:a}=s(3);t.exports={setupAuth:async function(t,e,s,n){a().resetValues();const o=new r(t,e,s),c=await o.init();if(t.spanButtonID){let t;t=null==n?new i(o):new n(o),await t.init()}return c},AuthStates:n,HumanInteractionInterface:o,serviceInfoFromUrl:r.getServiceInfoFromURL}},function(t,e,s){const r=s(0),n=s(2),o=s(1),{getStore:i}=s(3),a=s(5);class c{constructor(t,e,s){if(this.store=i(),this.settings=t,null!=t.authRequest.languageCode&&(this.store.languageCode=t.authRequest.languageCode),this.serviceInfoUrl=e,this.serviceCustomizations=s,!t)throw new Error("settings cannot be null");try{if(this.settings.onStateChange&&this.store.stateChangeListners.push(this.settings.onStateChange),!this.settings.authRequest)throw new Error("Missing settings.authRequest");if(this.settings.authRequest.returnURL=this.getReturnURL(this.settings.authRequest.returnURL),!this.settings.authRequest.requestingAppId)throw new Error("Missing settings.authRequest.requestingAppId");if(!this.settings.authRequest.requestedPermissions)throw new Error("Missing settings.authRequest.requestedPermissions")}catch(t){throw this.store.setState({id:o.ERROR,message:"During initialization",error:t}),t}}async init(){return this.store.setState({id:o.LOADING}),await this.fetchServiceInfo(),this.checkAutoLogin(),this.store.state.id!==o.AUTHORIZED&&await this.prepareForLogin(),await this.finishAuthProcessAfterRedirection(),this.store.assets=await this.loadAssets(),this.pryvService}async fetchServiceInfo(){if(this.pryvService)throw new Error("Browser service already initialized");this.pryvService=new n(this.serviceInfoUrl,this.serviceCustomizations,this.settings.authRequest.requestingAppId);try{this.pryvServiceInfo=await this.pryvService.info()}catch(t){throw this.store.setState({id:o.ERROR,message:"Cannot fetch service/info",error:t}),t}}checkAutoLogin(){let t=null;try{t=this.pryvService.getCurrentCookieInfo()}catch(t){console.log(t)}t&&this.store.setState({id:o.AUTHORIZED,apiEndpoint:t.apiEndpoint,displayName:t.displayName})}async finishAuthProcessAfterRedirection(){if(!r.isBrowser())return;const t=window.location.href;let e=await this.pollUrlReturningFromLogin(t);if(null!==e)try{const t=await r.superagent.get(e);this.pryvService.changeAuthStateDependingOnAccess(t.body)}catch(t){this.store.setState({id:o.ERROR,message:"Cannot fetch result",error:t})}}async prepareForLogin(){if(this.pryvService.deleteCurrentAuthInfo(),!this.pryvServiceInfo)throw new Error("Browser service must be initialized first");if(await this.postAccessIfNeeded(),this.store.accessData&&this.store.accessData.status==c.options.ACCESS_STATUS_NEED_SIGNIN){if(!this.store.accessData.url)throw new Error("Pryv Sign-In Error: NO SETUP. Please call Browser.setupAuth() first.");this.store.setState({id:o.INITIALIZED,serviceInfo:this.serviceInfo})}}async postAccessIfNeeded(){this.store.accessData||this.pryvService.changeAuthStateDependingOnAccess(await this.postAccess())}async postAccess(){try{return(await r.superagent.post(this.pryvServiceInfo.access).set("accept","json").send(this.settings.authRequest)).body}catch(t){throw this.store.setState({id:o.ERROR,message:"Requesting access",error:t}),t}}logOut(){const t=this.store.messages.LOGOUT_CONFIRM?this.store.messages.LOGOUT_CONFIRM:"Logout ?";confirm(t)&&this.prepareForLogin()}getReturnURL(t,e,s){let n=(t=t||c.options.RETURN_URL_AUTO+"#").slice(-1);if("#&?".indexOf(n)<0)throw new Error('Pryv access: Last character of --returnURL setting-- is not "?", "&" or "#": '+t);if(u(t)&&!r.browserIsMobileOrTablet(s))return!1;if(u(t)&&r.browserIsMobileOrTablet(s)||0===t.indexOf("self")){t=(e||window.location.href)+t.substring(4)}return r.cleanURLFromPrYvParams(t)}static getServiceInfoFromURL(t){return r.getQueryParamsFromURL(t||window.location.href)[c.options.SERVICE_INFO_QUERY_PARAM_KEY]}async pollUrlReturningFromLogin(t){const e=r.getQueryParamsFromURL(t);let s=null;return e.prYvkey&&(s=this.pryvServiceInfo.access+e.prYvkey),e.prYvpoll&&(s=e.prYvpoll),s}getState(){return this.store.state}async loadAssets(){let t={};try{if(t=await this.pryvService.assets(),"undefined"!=typeof location){await t.loginButtonLoadCSS();const e=await t.loginButtonGetMessages();e.LOADING?this.store.messages=a(this.store.languageCode,e):console.log("WARNING Messages cannot be loaded using defaults: ",e)}}catch(t){throw this.store.setState({id:o.ERROR,message:"Cannot fetch button visuals",error:t}),t}return t}}function u(t){return 0===t.indexOf(c.options.RETURN_URL_AUTO)}c.options={SERVICE_INFO_QUERY_PARAM_KEY:"pryvServiceInfoUrl",ACCESS_STATUS_NEED_SIGNIN:"NEED_SIGNIN",RETURN_URL_AUTO:"auto"},t.exports=c},function(t,e,s){const r=s(7),n=s(1);t.exports=class extends r{constructor(t){super(t)}async init(){this.auth.store.stateChangeListners.push(this.onStateChange.bind(this)),this._setupButton(),await this._loadAssets()}_setupButton(){this.loginButtonSpan=document.getElementById(this.auth.settings.spanButtonID),this.loginButtonSpan||console.log("WARNING: Pryv.Browser initialized with no spanButtonID"),this.loginButtonText=this.loginButtonSpan,this.loginButtonSpan.addEventListener("click",this.onClick.bind(this))}async _loadAssets(){this.loginButtonSpan.innerHTML=await this.auth.pryvService.getAssets().loginButtonGetHTML(),this.loginButtonText=document.getElementById("pryv-access-btn-text"),this.onStateChange()}onClick(){if(this.auth.store.state.id===n.AUTHORIZED)this.auth.logOut();else if(this.auth.store.state.id===n.INITIALIZED){if(this.auth.settings.authRequest.returnURL)return void(location.href=this.auth.pryvService.getAccessData().url);this._startLoginScreen()}}onStateChange(){this.text=this.auth.pryvService.defaultOnStateChange(),this.loginButtonText&&(this.loginButtonText.innerHTML=this.text)}async _startLoginScreen(){await this.auth.pryvService.startAuthRequest();let t=void 0!==window.screenX?window.screenX:window.screenLeft,e=void 0!==window.screenY?window.screenY:window.screenTop,s=void 0!==window.outerWidth?window.outerWidth:document.body.clientWidth,r=void 0!==window.outerHeight?window.outerHeight:document.body.clientHeight-22,n="width=400,height=620,left="+parseInt(t+(s-400)/2,10)+",top="+parseInt(e+(r-620)/2.5,10)+",scrollbars=yes";const o=this.auth.pryvService.getAccessData().authUrl||this.auth.pryvService.getAccessData().url;this.popup=window.open(o,"prYv Sign-in",n),this.popup?window.focus&&this.popup.focus():(this.auth.pryvService.stopAuthRequest(),console.log("FAILED_TO_OPEN_WINDOW"))}}},function(t){t.exports=JSON.parse('{"name":"pryv","version":"2.0.8","homepage":"https://github.com/pryv/lib-js","description":"Pryv Javascript Library","keywords":["Pryv"],"repository":{"type":"git","url":"git://github.com/pryv/lib-js"},"bugs":{"url":"https://github.com/pryv/lib-js/issues"},"author":{"name":"Pryv S.A."},"main":"src/index.js","license":"BSD-3-Clause","scripts":{"setup":"./scripts/setup-environment-dev.sh","build":"webpack --config webpack.config.js","doc":"node node_modules/jsdoc/jsdoc.js -c .jsdoc-conf.json","test":"mocha --reporter spec  test/**/*.test.js","test-debug":"mocha --inpect-brk=40000 --reporter spec  test/**/*.test.js ","test:browser":"npm run build; ","cover":"nyc npm run test && npm run cover:report","cover:report":"nyc report --reporter=lcov --reporter=html","webserver":"./node_modules/.bin/rec-la ./dist 9443","gh-pages":"./scripts/upload.sh","clear":"rm -r dist/ && npm run setup"},"contributors":[{"name":"Pierre-Mikael Legris","email":"perki@pryv.com"}],"dependencies":{"superagent":"^5.2.2"},"devDependencies":{"@pryv/lib-js-common":"git+https://github.com/pryv/lib-js-common.git#1.0.1","@pryv/monitor":"^1.0.0","@pryv/socket.io":"^1.0.1","chai":"^4.2.0","chai-as-promised":"^7.1.1","cuid":"^2.1.8","jsdoc":"^3.6.4","mocha":"^6.2.3","node-fetch":"^2.6.0","nyc":"^14.1.1","rec-la":"^0.1.16","universal-url":"^2.0.0","zombie":"^6.1.4"}}')}]);
//# sourceMappingURL=pryv-es6.js.map